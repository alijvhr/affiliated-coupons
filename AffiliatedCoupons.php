<?php
/**
 * Plugin Name: Affiliated coupons
 * Plugin URI: https://github.com/alijvhr/affiliated-coupons
 * Description: This plugin let you provide a coupon creation dashboard to your affiliate with max discount percent of his affiliation percent.
 * Version: 1.0
 * Author: alijvhr
 * Author URI: https://alijvhr.ir/
 * Text Domain: affiliated-coupons
 * Domain Path: /languages
 **/

if ( ! defined( 'ABSPATH' ) ) {
	die( 'No direct access allowed' );
}

define( 'AFFILIATED_COUPONS_PATH', __DIR__ );

global $wpdb, $aac_db_version, $aac_table_profit, $aac_table_payment;
$aac_db_version      = '1.0';
$aac_table_profit    = $wpdb->prefix . 'aac_profit';
$aac_table_payment   = $wpdb->prefix . 'aac_payment';
$aac_withdraw_status = [ 'pending', 'payed', 'rejected' ];
$aac_icon            = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gU3ZnIFZlY3RvciBJY29ucyA6IGh0dHA6Ly93d3cub25saW5ld2ViZm9udHMuY29tL2ljb24gLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMTAwMCAxMDAwIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAxMDAwIDEwMDAiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPG1ldGFkYXRhPiBTdmcgVmVjdG9yIEljb25zIDogaHR0cDovL3d3dy5vbmxpbmV3ZWJmb250cy5jb20vaWNvbiA8L21ldGFkYXRhPg0KPGc+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMDAwMDAsNTExLjAwMDAwMCkgc2NhbGUoMC4xMDAwMDAsLTAuMTAwMDAwKSI+PHBhdGggZmlsbD0iYmxhY2siIGQ9Ik0xNjA0LjYsMzA2NS45QzExNDguNiwyMjY2LjgsMTA4LjEsNDAwLjQsMTAwLjQsMzY3LjljLTUuOC0zNC41LDQ2LTcyLjgsMzYwLjItMjY2LjRDNjgyLjktMzIuNiw4NDUuOC0xMjAuOCw4NjguOC0xMTYuOWMyOC43LDMuOCwyMjYuMSwzMzkuMiw4MzEuNiwxNDE0LjJjNDM1LDc3NC4yLDc4OS41LDE0MjEuOCw3ODcuNiwxNDM1LjJjLTUuNywzMC43LTczMC4xLDQ4MS03NzIuMiw0ODFDMTcwMi40LDMyMTMuNCwxNjUyLjUsMzE0Ni40LDE2MDQuNiwzMDY1Ljl6Ii8+PHBhdGggZmlsbD0iYmxhY2siIGQ9Ik03ODg2LDI5ODUuNGMtMjg1LjUtMTc2LjMtMzY0LjEtMjMzLjgtMzYyLjItMjY0LjRjMS45LTUxLjcsMTU1OS44LTI4MjAuNywxNTk4LjEtMjg0MS43YzM2LjQtMTkuMiw3NjAuNyw0MTMuOSw3NzgsNDY1LjZjMTUuMyw0OS44LTE1NjcuNSwyODU3LjEtMTYxNS40LDI4NjIuOEM4MjY1LjQsMzIwOS42LDgwODcuMiwzMTEwLDc4ODYsMjk4NS40eiIvPjxwYXRoIGZpbGw9ImJsYWNrIiBkPSJNNDkwMC41LDI0MjUuOWMtMjk4LjktMjQuOS02MDUuNS03NC43LTc2NC42LTEyNC42Yy0xMTguOC0zOC4zLTE1OS02MS4zLTIxMi43LTEyMi42Yy0xMDkuMi0xMjguNC01NTcuNi03NjQuNi02ODQuMS05NzEuNWMtMTEzLjEtMTg0LTEyMC43LTIwNS0xMjIuNi0zMTYuMmMtMS45LTExMy4xLDAtMTIwLjcsNTMuNy0xNDUuNmM2OS0zNC41LDI5MS4zLTUuOCw0NTAuMyw1OS40YzIyOCw5Miw1MTkuMywzMzUuMyw2NzIuNiw1NjUuM2w2Ny4xLDk5LjZsMjM3LjYsNzYuN2MxMzAuMyw0Mi4yLDI1NC45LDc2LjYsMjc1LjksNzYuNmM2Ny4xLDAsODczLjgtNDM1LDEzMTYuNC03MTAuOWM0MjkuMi0yNjYuNCwxMjExLTgyNCwxNjU1LjYtMTE4Mi4zbDIyNi4xLTE4NGw4MC41LDQ0LjFDODI3OC44LTMzNy4zLDg0MTEtMjMwLDg1ODMuNS01Ny41bDE2MC45LDE2Mi45bC02MDkuNCwxMDc4LjhjLTMzMy40LDU5NC02MTMuMiwxMDg2LjUtNjIwLjgsMTA5Ni4xYy03LjcsNy43LTg2LjItNS43LTE3NC40LTI2LjhjLTIxNi41LTU1LjYtMzk0LjctNDIuMi04MjQsNTUuNmMtNDk2LjMsMTE1LTY4OS44LDEzOC0xMDg0LjYsMTM2LjFDNTI0MS42LDI0NDMuMSw1MDA0LDI0MzUuNCw0OTAwLjUsMjQyNS45eiIvPjxwYXRoIGZpbGw9ImJsYWNrIiBkPSJNMTg1NS42LDExNjEuMkwxMjI5LjEsNDcuOEwxMzI4LjctNjljNTUuNi02NS4yLDE0MS44LTE3Mi41LDE5My41LTIzNy42YzUxLjctNjcuMSw5NS44LTEyMC43LDk5LjYtMTIwLjdjMy44LDAsNDYsMjguNyw5Miw2NS4yYzI1Ni44LDE5NS40LDYzMC40LDg4LjEsNzkxLjQtMjI2LjFsNDYtOTJsODYuMiwxMTYuOWMxMTEuMSwxNTEuNCwyMjQuMiwyMTIuNywzOTYuNiwyMTIuN2MzMDQuNywwLDU1My44LTI0OS4xLDU1Ny42LTU1OS41bDEuOS0xMzAuM2g3MC45YzEwOS4yLDAsMjk4LjktMTA3LjMsMzgzLjItMjIwLjRjODQuMy0xMDkuMiwxMzgtMjY2LjQsMTI2LjUtMzczLjdsLTUuNy03Mi44bDg2LjItMTMuNGMxOTUuNS0yOC43LDM2NC4xLTE0Ny41LDQ1Mi4yLTMyMS45YzkyLTE4MC4xLDg0LjMtMzczLjctMjMtNTMyLjdjLTM2LjQtNTUuNi01OS40LTEwNS40LTUxLjctMTEzLjFjNy43LTcuNyw3MC45LTMyLjYsMTM5LjktNTUuNmM0NTQuMS0xNDUuNiw4MjcuOC0xNzguMiwxMDA5LjgtODguMWM5Ny43LDQ5LjgsMjgxLjcsMjI0LjIsMjcwLjIsMjU4LjdjLTMuOCwxMS41LTIyMC40LDEyMi42LTQ4NC44LDI1MWMtMjYyLjUsMTI4LjQtNDg0LjgsMjQxLjUtNDkyLjUsMjU0LjljLTI4LjcsNDQuMS0xNS4zLDEwNy4zLDMyLjYsMTM4YzQ2LDMwLjcsNTkuNCwyNC45LDU2OS4xLTIyMi4zYzU1MS45LTI2OC4zLDYxNS4xLTI4OS4zLDgxMC42LTI2MC42YzEyMC43LDE5LjIsMjEwLjgsMTAxLjYsMjQ5LjEsMjI4YzUzLjcsMTgwLjEsOTIsMTQ1LjYtNTc4LjcsNTMyLjdjLTMzNS4zLDE5My41LTYyNC43LDM2Ny45LTY0MS45LDM4Ny4xYy0xOS4yLDE3LjMtMzQuNSw0Ni0zNC41LDYxLjNjMCw0NC4xLDc2LjcsMTA5LjIsMTE1LDk5LjZjMTkuMi01LjgsMzIwLTE3NC40LDY2OC44LTM3NS42YzYyNi42LTM2Mi4xLDYzMi40LTM2Niw3NDUuNC0zNjZjMTQzLjcsMCwyMjYuMSwyOC43LDMwNi42LDEwMy41Yzc0LjcsNjksMTA1LjQsMTU5LDk1LjgsMjg1LjVsLTUuNyw5My45bC03MjguMiw0MzguOGMtNDAwLjUsMjQxLjUtNzM5LjcsNDU2LjEtNzU1LDQ3Ny4xYy0yMS4xLDMwLjYtMjEuMSw0OS44LTUuNyw4Ni4yYzQ0LjEsOTUuOCw5My45LDcyLjgsOTE3LjktNDIzLjVsNzgxLjgtNDY5LjVsMTQzLjcsNS43YzExMy4xLDMuOCwxNTcuMSwxNS4zLDIwNi45LDQ5LjhjMTQxLjgsMTAzLjUsMTgyLDMxNi4yLDg0LjMsNDYxLjhjLTYzLjIsOTMuOS0yOTMuMiwyODUuNS03OTkuMSw2NjNDNjQzNS40LDUzOC40LDU4NDEuNCw5MTUuOSw1MDQ0LjIsMTMyNmwtMTc4LjIsOTJsLTE3OC4yLTUzLjdsLTE4MC4xLTUzLjdsLTEzMC4zLTE2Mi45Yy0zMjAtMzk4LjYtNzYwLjctNjM0LjMtMTE0OS43LTYxMy4yYy0xNDkuNSw3LjctMjA2LjksMzQuNS0yODMuNiwxMzhjLTMyLjYsNDIuMi00MC4yLDc4LjYtMzguMywxODkuN2MxLjksMjAzLjEsNzQuNywzNDYuOCw0MjMuNSw4NDMuMWM4OC4xLDEyNC42LDE1OSwyMzMuOCwxNTksMjM5LjVjMCw3LjctMTA1LjQsMzAuNy0yMzMuOCw0OS44Yy0zMDYuNiw0Ni00NTQuMSw5Mi02MjQuNywxOTUuNWMtNzYuNiw0Ni0xNDEuOCw4NC4zLTE0My43LDg0LjNDMjQ4NC4yLDIyNzQuNSwyMjAwLjYsMTc3NC40LDE4NTUuNiwxMTYxLjJ6Ii8+PHBhdGggZmlsbD0iYmxhY2siIGQ9Ik0xODc0LjgtNDk0LjRjLTY1LjEtMzYuNC0zMDAuOC0zNTguMy0zMjUuOC00NDIuNmMtNDcuOS0xNzguMiwxMTEuMS00MDAuNSwzMTQuMy00MzYuOWMxMjQuNi0yMywxODkuNywyMywzNTAuNywyMzcuNmMxMzIuMiwxODAuMSwxNDMuNywyMDEuMiwxNDMuNywyODcuNGMwLDExOC44LTI0LjksMTg1LjktMTAxLjYsMjY2LjRDMjE0OC44LTQ2OS41LDE5ODkuOC00MzMuMSwxODc0LjgtNDk0LjR6Ii8+PHBhdGggZmlsbD0iYmxhY2siIGQ9Ik0yOTIxLjEtNTY5LjJjLTQyLjItMTkuMi0xNTcuMS0xNjEtNDAwLjUtNDkyLjVjLTE4Ny44LTI1NC45LTM1Mi42LTQ4Ni43LTM2Ni01MTMuNmMtOTMuOS0xODAuMSw3OC42LTQ1Ni4xLDI5Ny00NzcuMWMxNjQuOC0xNS4zLDE4Ny44LDUuOCw0NzUuMiwzOTYuN2M0ODQuOCw2NTkuMiw0NjUuNiw2MjYuNiw0NjUuNiw3MjguMkMzMzkyLjUtNjgwLjMsMzEyNC4yLTQ3NS4zLDI5MjEuMS01NjkuMnoiLz48cGF0aCBmaWxsPSJibGFjayIgZD0iTTM0OTcuOC0xMjYwLjljLTU1LjYtMjguNy01NjUuMy02OTkuNC02MTctODEyLjVjLTg2LjItMTg5LjcsODAuNS00NTYuMSwyOTguOS00NzcuMWMxNjEtMTUuMywxODUuOSw1LjcsNDQ4LjQsMzY2YzM1MC43LDQ4Mi45LDMzOS4yLDQ2My43LDMzOS4yLDU3Ni44YzAsMTIyLjYtNTcuNSwyMzAtMTYyLjksMzAyLjhDMzcwOC42LTEyMzcuOSwzNTc4LjMtMTIxOC44LDM0OTcuOC0xMjYwLjl6Ii8+PHBhdGggZmlsbD0iYmxhY2siIGQ9Ik00MDc2LjUtMTk1Ni41Yy02OS00Mi4yLTQxMC4xLTUwOS43LTQzNi45LTU5Ny45Yy00Mi4yLTEzOCw1NS42LTMyMS45LDIxNC42LTQwNC4zYzkwLjEtNDYsMTgyLTQ2LDI2MC42LTEuOWM3NC43LDQwLjMsNDE5LjYsNTAwLjEsNDQ4LjQsNTk3LjljMjguNyw5NS44LTUuOCwyMTIuNy05My45LDMxMC40QzQzNTQuNC0xOTIzLjksNDE5MS41LTE4ODMuNyw0MDc2LjUtMTk1Ni41eiIvPjwvZz48L2c+DQo8L3N2Zz4=';

function aac_plugin_load() {
	load_plugin_textdomain( 'affiliated-coupons', false, dirname( plugin_basename( __FILE__ ) ) . '/languages/' );
	add_rewrite_endpoint( 'affiliated-coupons', EP_ROOT | EP_PAGES );
	add_rewrite_endpoint( 'affiliated-coupons-create', EP_ROOT | EP_PAGES );
	add_rewrite_endpoint( 'affiliated-coupons-profit', EP_ROOT | EP_PAGES );
	add_rewrite_endpoint( 'affiliated-coupons-withdraw', EP_ROOT | EP_PAGES );
	add_rewrite_endpoint( 'affiliated-coupons-withdraw-create', EP_ROOT | EP_PAGES );
	if ( current_affiliate_percent() ) {
		wp_enqueue_style( 'aac-style' );
		aac_check_form_submit();
		aac_affiliated_menu_endpoint();
	}
}

require 'src/admin-menu.php';
require 'src/user-menu.php';
require 'src/functions.php';


//wp_register_script( 'aac-datepicker', plugins_url( 'assets/persianDatepicker.min.js', __FILE__ ), array( 'jquery' ), '1.0', true );
//wp_register_style( 'aac-datepicker', plugins_url( 'assets/persianDatepicker-default.css', __FILE__ ), '', '1.0' );
//wp_register_style( 'aac-style', plugins_url( 'assets/style.css', __FILE__ ), '', '1.0' );

add_action( 'init', 'aac_plugin_load' );

register_activation_hook(
	__FILE__,
	'aac_activation_hook'
);

function aac_activation_hook() {

	global $wpdb, $aac_db_version, $aac_table_profit, $aac_table_payment;

	$charset_collate = $wpdb->get_charset_collate();

	$sql  = "CREATE TABLE IF NOT EXISTS $aac_table_profit ( order_id mediumint(9) NOT NULL, order_date timestamp DEFAULT utc_timestamp NOT NULL, coupon_code varchar(250) NOT NULL, affiliate_id mediumint(9) NOT NULL, order_total decimal NOT NULL, user_discount decimal NOT NULL, profit decimal NOT NULL, PRIMARY KEY(order_id), INDEX(affiliate_id) ) $charset_collate;";
	$sql2 = "CREATE TABLE IF NOT EXISTS $aac_table_payment ( id mediumint(9) NOT NULL AUTO_INCREMENT, pay_date timestamp DEFAULT NULL NULL, amount decimal NOT NULL, affiliate_id mediumint(9) NOT NULL, status int DEFAULT 0 NOT NULL, description TEXT DEFAULT '' NOT NULL, PRIMARY KEY(id),  INDEX(affiliate_id) ) $charset_collate;";

	require_once ABSPATH . 'wp-admin/includes/upgrade.php';
	dbDelta( $sql );
	dbDelta( $sql2 );

	update_option( 'aac_db_version', $aac_db_version );

	flush_rewrite_rules( true );

}